name: Update ChangeLogs

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Release Electron App"]
    types:
      - completed

concurrency:
  group: update-changelogs-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write
  issues: write
  statuses: write

jobs:
  update_changelogs:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create Check Run
        id: create_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CHECKID=$(gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f name='Update ChangeLogs' \
            -f head_sha='${{ github.sha }}' \
            -f status='in_progress' \
            -f 'output[title]=Update ChangeLogs' \
            -f 'output[summary]=Changelog update in progress' \
            --jq '.id' \
            /repos/${{ github.repository }}/check-runs)
          echo "CHECKID=$CHECKID" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Install git-cliff
        run: npm install -g git-cliff

      - name: Generate CHANGELOG.md files
        run: |
          npx git-cliff --config cliff.toml --output CHANGELOG.md
          cd electron-app && npx git-cliff --config ../cliff.toml --output CHANGELOG.md && cd ..
          cd electron-app/icons && npx git-cliff --config ../../cliff.toml --output CHANGELOG.md && cd ../..
          cd electron-app/libs && npx git-cliff --config ../../cliff.toml --output CHANGELOG.md && cd ../..
          cd electron-app/screenshots && npx git-cliff --config ../../cliff.toml --output CHANGELOG.md && cd ../..
          cd electron-app/tests && npx git-cliff --config ../../cliff.toml --output CHANGELOG.md && cd ../..
          cd electron-app/utils && npx git-cliff --config ../../cliff.toml --output CHANGELOG.md && cd ../..

      - name: Create Pull Request for changelogs
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          commit-message: "chore: update changelogs [skip ci]"
          title: "chore: update changelogs"
          body: "Automated changelog update via GitHub Actions.\n\nThis PR was created automatically and will not be merged automatically."
          branch: "chore/update-changelogs"
          add-paths: '**/CHANGELOG.md'
          delete-branch: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Check Run - Changelogs Generated
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo '{
            "status": "in_progress",
            "output": {
              "title": "Update ChangeLogs",
              "summary": "Changelogs generated. Creating PR..."
            }
          }' | gh api -X PATCH -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/check-runs/$CHECKID --input -

      - name: Complete Check Run
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo '{
            "conclusion": "success",
            "output": {
              "title": "Update ChangeLogs",
              "summary": "Changelog update workflow completed successfully."
            }
          }' | gh api -X PATCH -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/check-runs/$CHECKID --input -

      - name: Add Job Summary
        if: always()
        run: |
          echo "## 📝 Changelog Update Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md files were generated or updated in the repository and subfolders." >> $GITHUB_STEP_SUMMARY
          echo "- A pull request was created or updated with the new changelogs." >> $GITHUB_STEP_SUMMARY
          echo "- Check runs were updated to reflect the workflow status." >> $GITHUB_STEP_SUMMARY
          echo "- Workflow completed with status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY